# 1️⃣ 1단계: 업로드 & 세션 캐시 (Mobile SAM CPU 기반)

## 🎯 목표
사용자가 웹에서 이미지를 업로드하면,  
**FastAPI 서버에서 Mobile SAM (CPU 전용)** 을 사용해 이미지 임베딩을 **1회 계산**하고,  
`session_id`를 반환하는 기능을 구현합니다.  

이 단계의 목적은 “Mobile SAM이 서버에서 정상 작동하는지”와 “세션 캐시 구조가 제대로 유지되는지”를 검증하는 것입니다.

---

## ⚙️ 주요 구성 요소

### 🔹 Frontend (Vite)
- **DnD(드래그앤드롭) + 클릭 업로드** 구현
- `/session` 엔드포인트로 `FormData`(이미지 파일) 전송
- 응답으로 받은 `session_id`를 상태로 저장
- 업로드 후 업로드된 이미지 미리보기 표시 (모델 추론 결과는 표시하지 않음)

### 🔹 Backend (FastAPI)
- `/session` 엔드포인트 구현
  - 이미지 파일 수신 (`multipart/form-data`)
  - 이미지 해상도 조정 (긴 변 최대 1024px)
  - Mobile SAM 모델로 **image embedding** 1회 계산
  - 결과를 메모리 또는 Redis 캐시에 저장 (`session_id` 키)
  - `session_id`를 JSON 형태로 반환  
    ```json
    { "session_id": "uuid-string" }
    ```

- **캐시 구조 예시 (RAM 버전)**
  ```python
  SESSION_CACHE = {
      "uuid-string": {
          "embedding": np.ndarray,
          "timestamp": datetime.utcnow()
      }
  }
  ```

- TTL 정책: 10분 미사용 시 자동 삭제  

### 🔹 Mobile SAM 설정 (CPU 전용)
- 모델: `mobile_sam.onnx` (또는 경량화 버전)
- 엔진: `ONNXRuntime`  
  - EP 우선순위: `['OpenVINOExecutionProvider', 'DnnlExecutionProvider', 'CPUExecutionProvider']`
- 입력 이미지: 긴 변 1024px 이하로 리사이즈 후 tensor 변환
- 출력: `image_embedding` numpy array (float32)

---

## 🧪 테스트 시나리오

| 테스트 항목 | 기대 결과 |
|--------------|-------------|
| 정상 이미지 업로드 | `{ "session_id": "<UUID>" }` 반환 |
| 비이미지 파일 업로드 | HTTP 415 (Unsupported Media Type) |
| 20MB 이상 이미지 업로드 | HTTP 413 (Payload Too Large) |
| 모델 로드 실패 | 500 에러 로그 남김 |
| 10분 이상 미사용 세션 | 캐시에서 자동 삭제 |

---

## ⚡ 성능 목표
- `/session` 요청 p95 지연시간: **≤ 2.5초 (CPU 기준)**  
- 이미지 리사이즈 처리 포함 end-to-end 응답 시간  
- ONNXRuntime 스레드 수 제어:  
  ```bash
  OMP_NUM_THREADS=4
  OPENBLAS_NUM_THREADS=1
  MKL_NUM_THREADS=4
  ```

---

## ✅ 완료 기준 (Definition of Done)
- [ ] Mobile SAM 모델이 CPU 환경에서 정상적으로 로드 및 추론됨  
- [ ] `/session` 요청 시 `session_id`가 반환되고 캐시에 embedding 저장됨  
- [ ] TTL(10분) 정책 작동 확인  
- [ ] 이미지 용량/형식 검증 및 예외 처리 정상 동작  
- [ ] 프런트에서 업로드 → 세션 ID 반환 → 미리보기 표시까지 완료

---

## 🧱 다음 단계
이 단계가 완료되면, **2단계: 클릭 좌표 수집 & /predict 구현** 으로 진행합니다.  
이때는 업로드된 이미지의 세션 캐시를 사용하여 클릭 좌표 기반 마스크 계산 기능을 추가합니다.
